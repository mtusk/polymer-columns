<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">

<dom-module id="miller-columns">
  <template>
    <style>
      :host {
        overflow-x: auto;
      }

      #selector {
        display: -webkit-box;
        display: -moz-box;
        display: -ms-flexbox;
        display: -webkit-flex;
        display: flex;
        flex-flow:row;
        height: 100%;
      }
    </style>

    <iron-selector
      id="selector"
      selected-item="{{selectedColumn}}"
      on-iron-items-changed="selectorItemsChanged"
      on-iron-activate="columnSelected">
      <template
        is="dom-repeat"
        items="{{columns}}"
        as="column">
        <miller-column
          items="{{column.items}}"
          on-move-left-right="moveLeftRight">
        </miller-column>
      </template>
    </iron-selector>

  </template>

  <script>
    Polymer({
      is: 'miller-columns',

      properties: {
        configuration: Object,
        selectedColumn: Object,
        columns: {
          type: Array,
          notify: true
        },
        path: {
          type: String,
          reflectToAttribute: true
        }
      },

      ready: function() {
        if (!this.configuration) {
          throw "'configuration' must be on <miller-columns>";
        }

        if (!this.configuration.getColumn) {
          throw "'configuration.getColumn' must be defined";
        }

        var column = this.configuration.getColumn([]);

        this.columns = [column];
      },

      moveLeftRight: function(event, payload, sender) {
        // console.log('about to change selected column')
        // console.log('selected column prior to any change:', this.$.selector.selectedItem);

        if (payload.direction === 'Left') {
          if (this.$.selector.selected > 0) {
            this.$.selector.selectPrevious();
            this.splice('columns', this.columns.length - 1, 1);
            this.$.selector.selectedItem.focus();
          }
        } else {
          var column = this.configuration.getColumn();
          this.push('columns', column);
          this.async(function() {
            this.$.selector.selectNext();
            this.$.selector.selectedItem.focus();
          }, 50);
        }
      },

      selectorItemsChanged: function() {
        if (!this.initialFocusSet) {
          this.$.selector.select(0);

          if (!!this.$.selector.selectedItem) {
            this.initialFocusSet = true;
            this.$.selector.selectedItem.focus();
          }
        }
      },

      columnSelected: function(event, columnToBeSelected) {
        // TODO for some reason this method is being triggered when an item is selected
        // as well as when a column is selected... is there a way to detect what type
        // of change we are handling or prevent items from triggering this????



        //console.log('column selected', this.$.selector.selectedItem);

        var selectedColumnIndex = this.$.selector.selected;

        this.path = _
          .chain(this.$.selector.items)
          .take(selectedColumnIndex + 1)
          .map('selectedItem')
          .map('name')
          .join('/')
          .value();
      }
    });
  </script>
</dom-module>
